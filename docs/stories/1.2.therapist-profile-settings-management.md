# Story 1.2: Therapist Profile & Settings Management

## Status

Ready For Development

## Story

**As a** therapist,
**I want** to manage my professional profile and application preferences,
**so that** the system reflects my practice and therapeutic approach.

## Acceptance Criteria

1. Create comprehensive professional profile form with fields for name, credentials, license info, and practice details
2. Implement therapy school preferences selection with default marma point sets and treatment approaches
3. Build application UI/UX customization options including theme, layout preferences, and notification settings
4. Add account security settings including password management, two-factor authentication options, and session management
5. Ensure all profile data is properly validated, secured, and integrated with Supabase user authentication
6. Implement proper form handling with real-time validation, error handling, and success feedback

## Tasks / Subtasks

- [ ] **Task 1: Create Professional Profile Form Component** (AC: 1, 5)
  - [ ] Create therapist profile form component with comprehensive field set
  - [ ] Implement form validation schema using Zod for all profile fields
  - [ ] Add proper TypeScript types for therapist profile data structure
  - [ ] Create API service functions for profile CRUD operations
  - [ ] Integrate form with React Hook Form for optimal user experience
  - [ ] Add real-time validation feedback and error handling

- [ ] **Task 2: Implement Therapy School Preferences System** (AC: 2)
  - [ ] Create therapy school selection component with available options
  - [ ] Build default marma point set configuration interface
  - [ ] Implement treatment approach preference selection
  - [ ] Create data models for therapy schools and point configurations
  - [ ] Add persistence layer for therapist preferences in Supabase
  - [ ] Include validation for therapy school preference dependencies

- [ ] **Task 3: Build UI/UX Customization Settings** (AC: 3)
  - [ ] Create theme selection component (light/dark/system preference)
  - [ ] Implement layout preference options (sidebar, compact view, etc.)
  - [ ] Add notification settings management interface
  - [ ] Create settings persistence layer with user preferences
  - [ ] Implement real-time theme switching and layout updates
  - [ ] Add accessibility options and preferences

- [ ] **Task 4: Implement Account Security Settings** (AC: 4)
  - [ ] Create password change form with current/new password validation
  - [ ] Add two-factor authentication setup and management interface
  - [ ] Implement session management and active session display
  - [ ] Create security audit log viewing functionality
  - [ ] Add account recovery options and backup codes management
  - [ ] Integrate with Supabase Auth security features

- [ ] **Task 5: Integration and Navigation Setup** (AC: 6)
  - [ ] Create main settings/profile page with proper navigation
  - [ ] Implement settings sections with tabbed or segmented interface
  - [ ] Add proper routing for different settings subsections
  - [ ] Create breadcrumb navigation and settings menu structure
  - [ ] Implement auto-save functionality for settings changes
  - [ ] Add success/error notifications for all settings operations

## Dev Notes

### Previous Story Insights

From Story 1.1.3 completion:

- React Router v6 successfully configured with proper TypeScript support
- Supabase client integration working with environment variable switching
- Authentication guards implemented for protected routes
- Navigation component uses proper React Router Links
- User authentication context established with role-based access control

### Technology Stack Context

[Source: docs/architecture/tech-stack.md]
**Required Dependencies:**

- **UI Components**: shadcn/ui components (already established)
- **Forms**: React Hook Form + Zod validation (specified in tech stack)
- **State Management**: React Query for server state, Zustand for local UI state
- **Styling**: TailwindCSS + shadcn/ui component system

**Current Dependencies Available:**

- `@supabase/supabase-js` - Database and auth operations
- `react-hook-form` + `zod` - Form handling and validation
- `@tanstack/react-query` - Server state management
- `tailwindcss` + shadcn/ui - UI components and styling

### Database Schema Context

[Source: docs/architecture/4-backend-database-supabase.md]
**Relevant Data Models:**

- **users** table: (id, email, role: 'therapist'|'client', stripe_customer_id, created_at)
- **therapists** table: (id -> users.id, profile, subscription_status)
- **schools** table: (id, name, description) - for therapy school preferences
- **points** table: (id, school_id, code, name, location_text, contraindications, indications, synonyms)

**Required Database Operations:**

- CRUD operations on therapists profile data
- Read operations on schools and points for preference selection
- User metadata updates through Supabase Auth

### Frontend Architecture Requirements

[Source: docs/architecture/3-frontend-architecture.md, docs/architecture/source-tree.md]
**Feature Module Structure:**

Profile/Settings should be organized in feature module pattern:

```
src/features/profile/
├── components/           # Profile-specific components
├── hooks/               # Profile data hooks (useProfile, useSettings)
├── services/            # Profile API calls
└── types.ts            # Profile type definitions
```

**Component Organization:**

- Profile forms in `src/features/profile/components/`
- Settings components following shadcn/ui patterns
- Shared form components in `src/components/forms/`

### File Naming and Import Conventions

[Source: docs/architecture/coding-standards.md]
**Component Standards:**

- **Components**: PascalCase (`ProfileForm.tsx`, `TherapySchoolSelector.tsx`)
- **Hooks**: camelCase with `use` prefix (`useProfile.ts`, `useSettings.ts`)
- **Services**: camelCase (`profileService.ts`, `settingsService.ts`)
- **Types**: camelCase (`profileTypes.ts`)

**Import Standards:**

```typescript
// Absolute imports from src root
import { ProfileForm } from '@/features/profile/components/ProfileForm';
import { useProfile } from '@/features/profile/hooks/useProfile';
import { supabase } from '@/lib/supabase';
```

### Form Validation and Data Handling

[Source: docs/architecture/coding-standards.md]
**Zod Schema Implementation:**

```typescript
// Profile validation schema
const profileSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters'),
  credentials: z.string().optional(),
  licenseNumber: z.string().optional(),
  practiceInfo: z.object({
    address: z.string().optional(),
    phone: z.string().optional(),
    website: z.string().url('Invalid website URL').optional(),
  }),
  therapySchool: z.string(),
  preferences: z.object({
    theme: z.enum(['light', 'dark', 'system']),
    notifications: z.boolean(),
    compactView: z.boolean(),
  }),
});

type ProfileFormData = z.infer<typeof profileSchema>;
```

**React Hook Form Integration:**

- Use `zodResolver` for form validation
- Implement proper error handling and display
- Add loading states for form submissions
- Include success feedback for settings changes

### Supabase Integration Requirements

[Source: docs/architecture/4-backend-database-supabase.md, Story 1.1.3 insights]
**Authentication Context:**

- User session management already established
- Role-based access control (therapist role)
- Profile data linked to authenticated user ID

**Database Operations:**

```typescript
// Profile operations
const getTherapistProfile = async (userId: string) => {
  return supabase.from('therapists').select('*').eq('id', userId).single();
};

const updateTherapistProfile = async (userId: string, profile: ProfileData) => {
  return supabase.from('therapists').update(profile).eq('id', userId);
};
```

### UI/UX Component Requirements

[Source: docs/architecture/coding-standards.md, shadcn/ui patterns]
**Settings Page Layout:**

- Tabbed interface for different settings sections
- Form sections with proper spacing and grouping
- Responsive design for mobile and desktop
- Consistent button and input styling using shadcn/ui
- Loading states and error handling for all forms

**Required shadcn/ui Components:**

- `Form` components for all forms
- `Tabs` for settings navigation
- `Switch` for toggle preferences
- `Select` for dropdown selections
- `Dialog` for confirmation modals
- `Toast` for success/error notifications

### Routing and Navigation Integration

[Source: Story 1.1.3 completion, docs/architecture/3-frontend-architecture.md]
**Route Structure:**

Protected routes under `/profile` and `/settings`:

- `/profile` - Main profile management
- `/settings` - Application preferences
- `/settings/security` - Security settings
- `/settings/preferences` - Therapy school and UI preferences

**Navigation Integration:**

- Add profile/settings links to existing Navigation component
- Implement breadcrumb navigation for settings subsections
- Use React Router for proper SPA navigation

### Security and Data Protection

[Source: docs/architecture/4-backend-database-supabase.md]
**Row-Level Security (RLS):**

- Therapist profiles accessible only by authenticated therapist
- Profile data tied to `auth.uid()` for security
- Secure file upload with proper access controls

**Data Validation:**

- Client-side validation with Zod schemas
- Server-side validation through Supabase policies
- Proper sanitization of user input data

### Performance Considerations

**React Query Integration:**

```typescript
// Optimized data fetching and caching
export const useProfile = (userId: string) => {
  return useQuery({
    queryKey: ['profile', userId],
    queryFn: () => getTherapistProfile(userId),
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
};

export const useUpdateProfile = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: updateTherapistProfile,
    onSuccess: (data, variables) => {
      queryClient.setQueryData(['profile', variables.userId], data);
    },
  });
};
```

### Testing Requirements

[Source: docs/architecture/coding-standards.md]
**Component Testing Standards:**

- Test profile form validation and submission
- Test settings persistence and retrieval
- Test theme switching and UI preference changes
- Use data-testid attributes for E2E test stability

**Test File Locations:**

- Profile component tests: `src/features/profile/components/__tests__/`
- Profile hook tests: `src/features/profile/hooks/__tests__/`
- Integration tests: `src/features/profile/__tests__/integration/`

**E2E Test Considerations:**

- Add data-testid attributes to all interactive elements
- Test complete profile creation and update flows
- Verify settings persistence across sessions

### Error Handling Requirements

**Form Error Handling:**

- Real-time validation feedback using Zod
- Network error handling for API calls
- User-friendly error messages and recovery options

**Fallback States:**

- Loading skeletons for profile data
- Graceful degradation for missing optional data
- Offline state handling for settings changes

### Project Structure Notes

Based on the established source tree structure, profile/settings functionality should be organized as follows:

```
src/
├── features/
│   └── profile/                 # New feature module
│       ├── components/
│       │   ├── ProfileForm.tsx
│       │   ├── SettingsForm.tsx
│       │   ├── TherapySchoolSelector.tsx
│       │   └── SecuritySettings.tsx
│       ├── hooks/
│       │   ├── useProfile.ts
│       │   ├── useSettings.ts
│       ├── services/
│       │   ├── profileService.ts
│       │   └── settingsService.ts
│       └── types.ts
├── components/
│   └── forms/                   # Shared form components
│       ├── FormField.tsx
└── lib/
    ├── validations.ts           # Extended with profile schemas
    └── constants.ts             # Add profile-related constants
```

## Testing

[Source: docs/architecture/coding-standards.md]

**Testing Framework Requirements:**

- React Testing Library for component testing
- Vitest for unit testing (already configured)
- Mock Supabase client for testing API interactions

**Test Coverage Requirements:**

- Profile form validation testing
- Settings persistence testing
- Theme switching and UI preference testing
- Security settings testing (password change, 2FA setup)

**Test File Organization:**

- Component tests in feature-specific `__tests__` directories
- Integration tests for complete profile management flows
- E2E tests using data-testid selectors for stability

**Required Test Utilities:**

```typescript
// Mock Supabase client for testing
const mockSupabase = {
  from: jest.fn().mockReturnThis(),
  select: jest.fn().mockReturnThis(),
  update: jest.fn().mockReturnThis(),
  insert: jest.fn().mockReturnThis(),
  eq: jest.fn().mockReturnThis(),
  single: jest.fn(),
};

// Test data factories
const createMockProfile = (): TherapistProfile => ({
  id: 'test-user-id',
  name: 'Test Therapist',
  credentials: 'Licensed Therapist',
  // ... other fields
});
```

## Change Log

| Date       | Version | Description                                             | Author       |
| ---------- | ------- | ------------------------------------------------------- | ------------ |
| 2025-09-11 | 1.0     | Initial story creation for therapist profile management | Scrum Master |
