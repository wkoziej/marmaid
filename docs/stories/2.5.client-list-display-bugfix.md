# Story 2.5: Client Management and Profile Forms Loading Bugfix

## Status

Ready

## Story

**As a** therapist using the Marmaid application,
**I want** to see my client list, add new clients, and access my therapist profile form,
**so that** I can manage my client profiles and maintain my professional information for therapy sessions.

## Acceptance Criteria

### Functional Requirements:

1. Client list loads and displays correctly when navigating to "Zarządzaj klientami"
2. Add client functionality works properly - users can successfully create new client profiles
3. Client search and filtering functionality works as expected
4. Navigation between client views (list, create form, edit form) functions correctly
5. All client-related data displays properly (names, status indicators, counts)
6. **Therapist profile form loads correctly** when navigating to "Zarządzaj profilem"
7. **Profile form displays all fields and accepts user input** instead of showing only header text
8. **Profile data loads and populates form fields** for existing therapist profiles
9. **Profile save functionality works correctly** without hanging or timing out

### Integration Requirements:

10. Client service API calls execute successfully without errors
11. Authentication context properly provides therapist ID for client queries
12. React Query caching works correctly for client data
13. Form validation displays properly and prevents invalid submissions
14. Error handling displays appropriate messages for network or validation failures
15. **Profile service API calls execute successfully** without RLS policy errors
16. **Profile hooks (useProfile, useUpdateProfile) function correctly** and load data
17. **Therapist profile database queries succeed** with proper user authentication
18. **Profile form React Hook Form integration works** without infinite loading states

### Quality Requirements:

19. No console errors appear during client management operations
20. Loading states display correctly during data operations
21. UI remains responsive during client operations
22. Existing E2E tests continue to pass (maintaining selector standardization work)
23. **No console errors appear during profile management operations**
24. **Profile form renders completely** without hanging in loading state
25. **Network requests complete successfully** for both client and profile operations

## Tasks / Subtasks

- [ ] **Investigation Phase** (AC: 1-9)
  - [ ] Analyze client list loading behavior in browser dev tools
  - [ ] Check network requests for client data retrieval
  - [ ] Verify authentication state and therapist ID availability
  - [ ] Test client creation form submission flow
  - [ ] Check React Query cache state and invalidation
  - [ ] **Analyze profile form loading behavior and stuck loading states**
  - [ ] **Check network requests for therapist profile data retrieval**
  - [ ] **Verify profile-service API calls and responses**
  - [ ] **Test profile form rendering and field population**

- [ ] **Debug Client & Profile Service Integration** (AC: 10-18)
  - [ ] Verify clientService.getClientsByTherapistId() functionality
  - [ ] Check useAuth hook providing correct therapist ID
  - [ ] Ensure React Query hooks (useClients) work properly
  - [ ] Test client creation API calls and responses
  - [ ] Verify error handling in client service calls
  - [ ] **Debug profileService.getProfile() and related methods**
  - [ ] **Verify useProfile hook functionality and data loading**
  - [ ] **Check therapist table RLS policies and permissions**
  - [ ] **Test profile form React Hook Form configuration**

- [ ] **Fix Frontend Component Issues** (AC: 19-25)
  - [ ] Debug ClientList component rendering logic
  - [ ] Fix ClientCreateForm submission and navigation
  - [ ] Ensure proper loading and error states display
  - [ ] Verify form validation and error message display
  - [ ] Test component state management and updates
  - [ ] **Fix ProfileForm component loading and rendering issues**
  - [ ] **Ensure profile form exits loading state and displays form fields**
  - [ ] **Fix profile form data population and submission workflow**

- [ ] **Regression Testing** (AC: 22)
  - [ ] Run E2E test suite to ensure no regressions
  - [ ] Verify data-testid selectors still work correctly
  - [ ] Test manual user workflows end-to-end
  - [ ] Confirm all client management features work as expected
  - [ ] **Verify all profile management features work as expected**
  - [ ] **Test both client and profile workflows manually**

## Dev Notes

### Relevant Source Tree Information:

- **Client Components**: `/src/features/clients/components/`
  - `ClientList.tsx` - Main list component with search/filter
  - `ClientCreateForm.tsx` - Form for adding new clients
- **Client Services**: `/src/features/clients/`
  - `client-service.ts` - API service layer with encryption
  - `client-hooks.ts` - React Query hooks for data management
  - `client-types.ts` - TypeScript type definitions
- **Profile Components**: `/src/features/auth/`
  - `ProfileForm.tsx` - **Therapist profile editing form**
  - `profile-service.ts` - **API service for therapist profiles**
  - `profile-hooks.ts` - **React Query hooks for profile management**
  - `auth-types.ts` - **TypeScript types for profile data**
- **Authentication**: `/src/features/auth/`
  - `auth-context.tsx` - Provides user/therapist context
  - `use-auth.ts` - Auth hook for accessing user state
- **Dashboard**: `/src/app/pages/dashboard.tsx` - Navigation entry point

### Previous Story Context:

- Story 2.2 implemented data-testid standardization for E2E tests
- E2E tests are passing (235/240) but real application functionality is broken
- Authentication system is working (user can login and access dashboard)
- **CRITICAL DISCOVERY**: Issue affects BOTH client management AND profile management
- **Profile form appears to be stuck in loading state** (shows only "Profil terapeuty" header)
- **Client list fails to load or display** despite working E2E tests
- Issue appears to be systemic API/service layer problem, not just authentication

### Key Technical Notes:

- Client data uses encryption service for sensitive fields
- React Query manages client data caching with specific query keys
- Forms use React Hook Form with Zod validation and error codes
- RLS (Row Level Security) policies control data access in Supabase
- **ProfileForm uses useProfile hook** which may be failing or stuck in loading state
- **Both ClientList and ProfileForm share similar patterns** - React Query + service layer
- **Problem likely in API connectivity, RLS policies, or React Query configuration**
- **Therapist profile data stored in 'therapists' table** with user ID as primary key

### Testing Standards:

- **Test File Locations**:
  - Unit tests: `/src/features/clients/__tests__/` and `/src/features/auth/__tests__/`
  - Integration tests: `/src/features/clients/__tests__/*integration*` and `/src/features/auth/__tests__/*integration*`
  - E2E tests: `/src/e2e/clients*.e2e.test.ts` and `/src/e2e/auth*.e2e.test.ts`
- **Testing Frameworks**:
  - Unit/Integration: Vitest + React Testing Library
  - E2E: Playwright with data-testid selectors (standardized in Story 2.2)
- **Testing Requirements**:
  - Maintain 98%+ E2E test success rate achieved in Story 2.2
  - Add specific tests for the bug scenarios being fixed
  - Verify both successful data loading and error handling paths
  - Test client creation workflow from start to finish
  - **Test profile form loading and data population**
  - **Verify both client and profile service API functionality**
  - **Add tests for stuck loading state scenarios**

## Change Log

| Date       | Version | Description                                                                                                                 | Author     |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2025-09-09 | 1.0     | Initial story creation for client list display bug                                                                          | Sarah (PO) |
| 2025-09-09 | 1.1     | **Expanded to include therapist profile form bug** - discovered systemic issue affecting both client and profile management | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent_
