# Story 1.1.3: Routing and Integration Setup

## Status

Ready For Review

## Story

**As a** development team,
**I want** to setup basic React Router in the new root structure and ensure Supabase client integration works from root directory with updated build and development scripts,
**so that** we have a working SPA routing foundation and backend integration ready for feature implementation while maintaining all existing quality standards.

## Acceptance Criteria

1. Install and configure React Router DOM in root structure with proper TypeScript configuration
2. Create basic routing structure in src/app/router.tsx with authentication-aware route guards
3. Setup Supabase client configuration in src/lib/supabase.ts with proper environment variables
4. Update build and development scripts to work correctly with React Router and Supabase integration
5. Verify routing works correctly in development and production builds with browser history API
6. Ensure all existing tests pass and CI/CD workflows work with new routing and integration setup
7. Create basic layout structure and navigation scaffolding for future feature implementation

## Tasks / Subtasks

- [ ] **Task 1: React Router Installation and Configuration** (AC: 1, 4)
  - [ ] Install react-router-dom and @types/react-router-dom packages
  - [ ] Create src/app/router.tsx with React Router v6 configuration
  - [ ] Configure TypeScript types for router configuration
  - [ ] Update vite.config.ts for SPA routing with fallback to index.html
  - [ ] Test router configuration with basic routes (/, /login, /dashboard)
  - [ ] Verify browser history API works correctly in development

- [ ] **Task 2: Route Structure and Guards Setup** (AC: 2, 7)
  - [ ] Create src/lib/auth-guards.ts for protected route implementation
  - [ ] Setup basic route structure in router.tsx (public and protected routes)
  - [ ] Create src/app/layout.tsx for application layout wrapper
  - [ ] Create basic navigation component in src/components/navigation/
  - [ ] Add route guards for authentication-required routes
  - [ ] Implement routing navigation structure following feature module pattern

- [ ] **Task 3: Supabase Client Integration** (AC: 3)
  - [ ] Install @supabase/supabase-js package
  - [ ] Create src/lib/supabase.ts with Supabase client configuration
  - [ ] Setup environment variables (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
  - [ ] Create TypeScript types for Database schema in src/lib/types.ts
  - [ ] Test Supabase connection and basic client functionality
  - [ ] Verify integration with environment switching scripts (test/prod)

- [ ] **Task 4: Build and Development Script Updates** (AC: 4, 5)
  - [ ] Update package.json scripts to handle SPA routing build requirements
  - [ ] Configure Vite build to properly handle client-side routing fallback
  - [ ] Update development server configuration for SPA routing
  - [ ] Test npm run build produces correct SPA routing configuration
  - [ ] Test npm run preview serves routes correctly
  - [ ] Verify production build routing works with history API

- [ ] **Task 5: Testing and CI/CD Integration** (AC: 6)
  - [ ] Update existing tests to work with React Router context
  - [ ] Create basic routing tests in tests/ directory using testing-library
  - [ ] Ensure all existing unit tests pass with new routing setup
  - [ ] Update CI/CD workflows to work with environment variable requirements
  - [ ] Test quality gates pass with new routing and Supabase integration
  - [ ] Verify GitHub Actions workflow succeeds with routing configuration

## Dev Notes

### Previous Story Insights

From Story 1.1.1 completion:

- Root structure migration successful with src/, public/, tests/ directories established
- Vite + React + TypeScript configuration working from root with minimal landing page
- ESLint configuration (eslint.config.js) in root and functional
- Vitest configuration integrated in vite.config.ts and working
- Package.json configured as main workspace with frontend/ preserved
- CI/CD pipeline updated to work with root structure

From Story 1.1.2 status (Ready For Dev):

- TailwindCSS 4, Prettier, and Playwright configurations ready for migration
- Tooling infrastructure prepared for root-based development
- Quality gates and pre-commit hooks ready for integration

### Technology Stack Context

[Source: docs/architecture/tech-stack.md]
**Required Dependencies:**

- **Routing**: `react-router-dom` - Standard SPA routing solution
- **Backend Integration**: `@supabase/supabase-js` - Supabase client for auth and database
- **Environment**: Node.js >=18.0.0, NPM >=9.0.0, TypeScript ^5.0.0
- **Build System**: Vite ^7.1.2 + React 19 + TypeScript 5.8.3 (established)

**Current Root Structure (after Story 1.1.1):**
[Source: docs/architecture/source-tree.md, Story 1.1.1 completion]

```
[root]/
├── src/
│   ├── app/                    # Routing, layout (needs router setup)
│   ├── components/             # UI components (needs navigation)
│   ├── features/               # Feature modules (auth, clients, etc.)
│   ├── lib/                    # Utilities, helpers (needs supabase.ts)
│   ├── hooks/                  # Global/shared hooks
│   ├── styles/                 # Styling (globals.css exists)
│   ├── assets/                 # Static assets
│   └── main.tsx               # App entry point (needs router)
├── public/                     # Static assets
├── tests/                      # Test directory (empty, ready)
├── package.json               # Main project package
├── vite.config.ts             # Vite config with Vitest
├── tsconfig.json              # TypeScript config
└── eslint.config.js           # ESLint config
```

**Target Structure (after Story 1.1.3):**

```
[root]/
├── src/
│   ├── app/
│   │   ├── router.tsx          # React Router configuration
│   │   ├── layout.tsx          # Application layout wrapper
│   │   └── providers.tsx       # Context providers (future)
│   ├── components/
│   │   └── navigation/         # Navigation components
│   ├── lib/
│   │   ├── supabase.ts         # Supabase client setup
│   │   ├── auth-guards.ts      # Route protection utilities
│   │   ├── types.ts            # Database/global types
│   │   └── utils.ts            # General utilities
│   └── main.tsx               # Updated with router
└── [other existing structure]
```

### Frontend Architecture Patterns

[Source: docs/architecture/3-frontend-architecture.md]
**Routing Requirements:**

- **Protected routes** with auth guards - access to data only after login
- **Feature-based routing** following feature module structure:
  - `/auth/*` - Authentication (login, register, reset)
  - `/clients/*` - Client management and intake preview
  - `/sessions/*` - Session logging and notes
  - `/planning/*` - Therapy planning and point selection
  - `/dashboard` - Main dashboard after login

**State Management Integration:**

- React Query for server state synchronization with Supabase
- Route guards for authentication state management
- Feature module isolation with routing boundaries

### Supabase Integration Requirements

[Source: docs/architecture/tech-stack.md, docs/architecture/4-backend-database-supabase.md]
**Client Configuration:**

- Environment variables: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY
- TypeScript integration with Database types
- Auth integration for protected routes
- Multiple environment support (local/test/prod)

**Environment Scripts Integration:**
[Source: package.json analysis]

- `npm run env:test` - Switch to test Supabase environment
- `npm run env:prod` - Switch to production Supabase environment
- `npm run env:local` - Switch to local development environment

### File Naming and Import Conventions

[Source: docs/architecture/coding-standards.md]
**Component Standards:**

- **Components**: PascalCase (`Router.tsx`, `Layout.tsx`)
- **Hooks**: camelCase with `use` prefix (`useAuth.ts`)
- **Services**: camelCase (`supabaseClient.ts`)
- **Utils**: camelCase (`authGuards.ts`)

**Import Standards:**

```typescript
// Absolute imports from src root
import { Router } from '@/app/router';
import { supabase } from '@/lib/supabase';
import { ProtectedRoute } from '@/lib/auth-guards';
```

### Routing Architecture Standards

[Source: docs/architecture/coding-standards.md, docs/architecture/3-frontend-architecture.md]
**React Router Configuration:**

```typescript
// Router setup with TypeScript and protected routes
const router = createBrowserRouter([
  {
    path: "/",
    element: <Layout />,
    children: [
      { path: "/", element: <LandingPage /> },
      { path: "/login", element: <LoginPage /> },
      {
        path: "/dashboard",
        element: <ProtectedRoute><Dashboard /></ProtectedRoute>
      }
    ]
  }
])
```

**Route Guard Implementation:**

- Check authentication state before rendering protected routes
- Redirect unauthenticated users to login page
- Preserve intended destination for post-login navigation

### Build Configuration Requirements

[Source: vite.config.ts analysis, Epic requirements]
**Vite SPA Configuration:**

- Configure `historyApiFallback` for client-side routing
- Ensure production builds serve index.html for all routes
- Environment variable injection for Supabase configuration
- Integration with existing TypeScript and testing setup

**Quality Gate Integration:**

- All existing tests must pass with new routing context
- ESLint rules for React Router best practices
- TypeScript strict checking for route parameters and guards

### Testing Requirements

[Source: docs/architecture/coding-standards.md#testing-standards]
**Router Testing Standards:**

- Test components wrapped in Router context
- Use MemoryRouter for isolated component testing
- Test route navigation and guard functionality
- Verify protected route authentication flow

**File Structure for Tests:**

- Router tests: `tests/routing/` (new directory)
- Integration tests with routing: existing `src/features/*/__tests__/*integration.test.*`
- Mock Supabase client for testing: `src/lib/__tests__/supabase.test.ts`

### Environment Variables Configuration

**Development Environment:**

```bash
# .env.local (for development)
VITE_SUPABASE_URL=your_local_supabase_url
VITE_SUPABASE_ANON_KEY=your_local_supabase_anon_key
```

**Integration with Existing Scripts:**

- Environment switching scripts will update these variables
- CI/CD workflows need access to test environment variables
- Production build requires production Supabase configuration

### Integration Points to Preserve

[Source: Epic Description, Story 1.1.1 insights]
**Critical Integrations:**

- **Vite Configuration**: Maintain existing React + TypeScript + Vitest setup
- **CI/CD Workflows**: GitHub Actions must work with environment variables
- **Quality Gates**: All pre-commit hooks and quality gates must pass
- **Development Scripts**: All npm scripts must work with routing changes
- **Build Process**: Production builds must support SPA routing properly

### Risk Mitigation Context

**Primary Risks:**

- Breaking existing development workflow during routing setup
- Supabase configuration conflicts with environment switching
- Production build routing issues with client-side navigation

**Mitigation Approach:**

- Test each integration point separately (Router, Supabase, Build)
- Verify environment switching works with new Supabase integration
- Ensure fallback routes work correctly in production builds

### Package.json Updates Required

**New Dependencies:**

```json
{
  "dependencies": {
    "react-router-dom": "^6.0.0",
    "@supabase/supabase-js": "^2.0.0"
  },
  "devDependencies": {
    "@types/react-router-dom": "^5.3.0"
  }
}
```

**Script Verification:**

- Ensure all existing scripts work with new dependencies
- Test development server handles routing correctly
- Verify build process creates SPA-compatible output

### Testing

[Source: docs/architecture/coding-standards.md#testing-standards]

**Router Testing Requirements:**

- Create `tests/routing/router.test.tsx` for route configuration testing
- Test protected route guards redirect unauthenticated users
- Test navigation between different route paths
- Mock Supabase authentication for route guard testing

**Integration Testing:**

- Test components render correctly within router context
- Verify environment variable loading in different environments
- Test Supabase client initialization and connection

**E2E Testing Preparation:**

- Ensure routing works with future Playwright E2E tests
- Add data-testid attributes to navigation elements
- Prepare routing for client management and authentication flows

**Test File Locations:**

- Router unit tests: `tests/routing/` (new directory)
- Supabase integration tests: `src/lib/__tests__/` (new directory)
- Component integration with router: existing feature test directories

## Change Log

| Date       | Version | Description                                                       | Author       |
| ---------- | ------- | ----------------------------------------------------------------- | ------------ |
| 2025-09-11 | 1.0     | Initial story creation for routing and Supabase integration setup | Scrum Master |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-20250514

### Development Progress

#### Task 1: React Router Installation and Configuration ✅

- [x] Install react-router-dom and @types/react-router-dom packages
- [x] Create src/app/router.tsx with React Router v6 configuration
- [x] Configure TypeScript types for router configuration
- [x] Update vite.config.ts for SPA routing with fallback to index.html
- [x] Test router configuration with basic routes (/, /login, /dashboard)
- [x] Verify browser history API works correctly in development

#### Task 2: Route Structure and Guards Setup ✅

- [x] Create src/lib/auth-guards.tsx for protected route implementation
- [x] Setup basic route structure in router.tsx (public and protected routes)
- [x] Create src/app/layout.tsx for application layout wrapper
- [x] Create basic navigation component in src/components/navigation/
- [x] Add route guards for authentication-required routes
- [x] Implement routing navigation structure following feature module pattern

#### Task 3: Supabase Client Integration ✅

- [x] Install @supabase/supabase-js package
- [x] Create src/lib/supabase.ts with Supabase client configuration
- [x] Setup environment variables (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
- [x] Create TypeScript types for Database schema in src/lib/types.ts
- [x] Test Supabase connection and basic client functionality
- [x] Verify integration with environment switching scripts (test/prod)

#### Task 4: Build and Development Script Updates ✅

- [x] Update package.json scripts to handle SPA routing build requirements (already configured)
- [x] Configure Vite build to properly handle client-side routing fallback
- [x] Update development server configuration for SPA routing
- [x] Test npm run build produces correct SPA routing configuration
- [x] Test npm run preview serves routes correctly
- [x] Verify production build routing works with history API

#### Task 5: Testing and CI/CD Integration ✅

- [x] Update existing tests to work with React Router context
- [x] Create basic routing tests in tests/ directory using testing-library
- [x] Ensure all existing unit tests pass with new routing setup
- [x] Update CI/CD workflows to work with environment variable requirements (env vars already configured)
- [x] Test quality gates pass with new routing and Supabase integration
- [x] Verify GitHub Actions workflow succeeds with routing configuration

### File List

- **Created**: src/app/router.tsx - React Router v6 configuration with basic routes
- **Created**: src/app/layout.tsx - Application layout wrapper with navigation
- **Created**: src/lib/auth-guards.tsx - Protected route components and authentication utilities
- **Created**: src/lib/supabase.ts - Supabase client configuration
- **Created**: src/lib/types.ts - TypeScript type definitions for Database and auth
- **Created**: src/lib/supabase-test.tsx - Temporary Supabase connection test component
- **Created**: src/components/navigation/Navigation.tsx - Navigation component with React Router Links
- **Created**: src/components/navigation/index.ts - Navigation re-exports
- **Created**: tests/routing/router.test.tsx - Basic routing tests using React Testing Library
- **Modified**: src/main.tsx - Updated to use RouterProvider instead of App directly
- **Modified**: src/App.tsx - Added SupabaseConnectionTest component
- **Modified**: vite.config.ts - Added SPA routing configuration and expanded test include patterns

### Debug Log References

- All tests passing: 24 unit tests successful
- Build process: Production builds working correctly with SPA routing
- Supabase integration: Connection testing implemented, handles missing tables gracefully
- Router functionality: Basic routes (/, /login, /dashboard) working with authentication guards

### Completion Notes

- React Router v6 successfully configured with proper TypeScript support
- Supabase client integration working with environment variable switching
- Authentication guards implemented for protected routes
- All existing quality gates maintained - no test regressions
- Navigation component uses proper React Router Links for SPA behavior
- Development and production builds both support client-side routing fallback
- Comprehensive test coverage for routing functionality added

### Change Log

| Date       | Description                                          | Files Modified            |
| ---------- | ---------------------------------------------------- | ------------------------- |
| 2025-09-11 | React Router and Supabase integration setup complete | 12 files created/modified |

### Status

Ready for Review

## QA Results

### Review Date: 2025-09-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates high-quality code with proper separation of concerns and adherence to established patterns. React Router v6 is correctly configured with TypeScript support, Supabase integration is properly implemented with environment variable validation, and authentication guards provide appropriate route protection. The code follows clean architecture principles with well-structured components and utilities.

### Refactoring Performed

- **File**: src/lib/auth-guards.tsx
  - **Change**: Replaced hardcoded 'therapist' role with dynamic role extraction from user metadata
  - **Why**: The original implementation always assigned 'therapist' role regardless of actual user role, which would break role-based access control
  - **How**: Modified user role assignment to use `session.user.user_metadata?.role` with 'therapist' as fallback, ensuring proper role-based authorization

### Compliance Check

- Coding Standards: ✓ All files follow TypeScript standards, proper ABOUTME comments, clean component patterns
- Project Structure: ✓ Follows feature-based architecture with proper src/app/, src/lib/, src/components/ organization
- Testing Strategy: ✓ Comprehensive test coverage using React Testing Library with proper isolation and mocking
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and validated

### Improvements Checklist

- [x] Refactored auth-guards.tsx to use dynamic role assignment from user metadata
- [x] Validated comprehensive test coverage (24/24 tests passing)
- [x] Verified proper TypeScript typing throughout implementation
- [x] Confirmed SPA routing configuration in Vite build setup
- [ ] Consider adding integration tests for actual Supabase auth flow (future story)
- [ ] Address E2E test configuration issue (unrelated to this story)

### Security Review

Authentication and authorization implementation is robust with proper session management, role-based access control, and secure environment variable handling. Supabase client is correctly configured with session persistence and auto-refresh tokens. Protected routes properly redirect unauthenticated users and enforce role-based permissions.

### Performance Considerations

Implementation follows performance best practices with efficient client-side routing, minimal bundle overhead from React Router, and proper auth state management. SPA configuration ensures fast navigation without full page refreshes.

### Files Modified During Review

- src/lib/auth-guards.tsx (improved role assignment logic)

### Gate Status

Gate: PASS → docs/qa/gates/1.1.3-routing-and-integration-setup.yml

### Recommended Status

✓ Ready for Done - All acceptance criteria met, comprehensive test coverage achieved, and implementation follows established standards with only minor improvement applied during review.
