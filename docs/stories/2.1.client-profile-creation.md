# Story 2.1: client-profile-creation

## Status
Ready for Development

## Story
**As a** therapist,
**I want** to create and edit comprehensive client profiles,
**so that** I can maintain structured records of each client's basic information and therapy context.

## Acceptance Criteria

1. Therapist can create new client profiles with personal information (name, contact details, basic demographics)
2. Therapist can edit existing client profiles with validation and error handling
3. Therapist can add therapy-relevant health information, conditions, and emergency contacts
4. Client profiles include categorization and tagging system for organization
5. All client data is validated using Zod schemas before saving
6. Existing authentication system continues to work unchanged
7. New functionality follows existing security patterns (RLS, audit logging, encryption)
8. Integration with therapists table maintains current behavior and extends user capabilities
9. Client data creation and updates are covered by unit and integration tests
10. Security measures match existing authentication patterns (RLS policies, audit trails)
11. No regression in existing authentication or profile functionality verified

## Tasks / Subtasks

- [ ] Create database migration for clients table (AC: 6,7,8)
  - [ ] Define clients table schema with proper relationships
  - [ ] Create RLS policies for therapist-only access
  - [ ] Add database indexes for performance
- [ ] Implement client data service layer (AC: 1,2,3,5,7)
  - [ ] Create client CRUD operations with Supabase
  - [ ] Add data validation and error handling
  - [ ] Implement audit logging for client operations
- [ ] Create client profile forms and UI components (AC: 1,2,3,4,5)
  - [ ] Build client creation form with validation
  - [ ] Build client editing form with existing data
  - [ ] Add tagging and categorization interface
  - [ ] Implement mobile-responsive design
- [ ] Add comprehensive testing coverage (AC: 9,11)
  - [ ] Unit tests for client components
  - [ ] Integration tests for client CRUD operations
  - [ ] Regression tests for authentication flow
- [ ] Security implementation and audit (AC: 7,8,10)
  - [ ] Implement data encryption for sensitive fields
  - [ ] Verify RLS policies work correctly
  - [ ] Audit client data access patterns

## Definition of Done
- [ ] All acceptance criteria met and verified
- [ ] Code passes all linting and type checking
- [ ] Test coverage ≥90% for new code
- [ ] Manual testing completed on key user flows
- [ ] Security review completed for RLS policies
- [ ] Performance testing shows no regression
- [ ] Documentation updated (if applicable)

## Dev Notes

### Architecture Integration
- **Existing System Context:** Application uses feature-based architecture with `features/auth/` as reference pattern
- **Technology Stack:** React + TypeScript, Supabase with RLS, React Hook Form + Zod validation, TailwindCSS
- **Security Foundation:** Built on existing authentication system with therapists table, audit logging via auditService
- **Database Integration:** Extends existing therapists table with one-to-many relationship to clients

### Key Implementation Details
- **Client Data Model:** JSONB fields for flexible profile data, health info, and emergency contacts
- **Access Control:** RLS policies restrict therapists to their own clients only
- **Data Flow:** Follow existing auth patterns: service layer → hooks → components → forms
- **File Structure:** Mirror `features/auth/` with services/, components/, hooks/, types/, schemas/, __tests__/

### Existing Patterns to Follow
- **Service Pattern:** Follow `features/auth/profile-service.ts` for CRUD operations
- **Hook Pattern:** Follow `features/auth/profile-hooks.ts` for React Query integration
- **Component Pattern:** Follow `features/auth/ProfileForm.tsx` for form structure
- **Schema Pattern:** Follow `features/auth/auth-schemas.ts` for Zod validation
- **Testing Pattern:** Follow `features/auth/__tests__/` structure for comprehensive testing

### Database Schema Reference
```sql
CREATE TABLE IF NOT EXISTS public.clients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  therapist_id UUID NOT NULL REFERENCES public.therapists(id) ON DELETE CASCADE,
  profile JSONB NOT NULL DEFAULT '{}',
  health_info JSONB DEFAULT '{}', 
  emergency_contacts JSONB DEFAULT '[]',
  tags TEXT[] DEFAULT '{}',
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Required indexes for performance
CREATE INDEX idx_clients_therapist_id ON public.clients(therapist_id);
CREATE INDEX idx_clients_status ON public.clients(status);
CREATE INDEX idx_clients_tags ON public.clients USING GIN(tags);

-- RLS Policies
ALTER TABLE public.clients ENABLE ROW LEVEL SECURITY;
CREATE POLICY clients_therapist_policy ON public.clients 
  FOR ALL TO authenticated 
  USING (therapist_id = auth.uid());
```

### Testing Standards

**Test File Locations:**
- Unit tests: `src/features/clients/__tests__/`
- Integration tests: `src/features/clients/__tests__/*-integration.test.tsx`
- E2E tests: `src/e2e/clients.e2e.test.ts`

**Testing Frameworks and Patterns:**
- **Unit Testing:** Vitest + React Testing Library (follow existing auth test patterns)
- **Integration Testing:** Vitest with Supabase test client and auth mocks
- **E2E Testing:** Playwright (follow existing auth E2E patterns)
- **Coverage Requirements:** Unit tests for all components, integration tests for CRUD operations

**Specific Testing Requirements:**
- Test client CRUD operations with proper authentication
- Test RLS policies prevent cross-therapist data access
- Test form validation with invalid/valid data scenarios
- Test error handling and loading states
- Regression test existing authentication flows remain unaffected

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-03 | 1.0 | Initial story creation from Epic 2 requirements | Sarah (PO) |
| 2025-09-03 | 1.1 | Added Definition of Done, enhanced DB schema with indexes/RLS, status change to Ready | Mary (BA) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during development*

### Debug Log References  
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results

*Results from QA Agent review of completed story implementation will be added here*