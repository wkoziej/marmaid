# Story 1.2: Therapist Profile & Settings Management

## Status
Draft

## Story
**As a therapist**, I want to manage my professional profile and application preferences so that the system reflects my practice and therapeutic approach.

## Acceptance Criteria

### MVP Core Features (Implementation Priority)
1. **Professional Profile Creation**: Therapist can create and edit basic professional profile with name, credentials, and practice information
2. **Account Security Management**: Therapist can manage password, email, and other security settings through secure interface
3. **Profile Validation**: All profile information is properly validated and stored securely with appropriate error handling
4. **Settings Persistence**: Profile changes are saved and persist across sessions with proper data synchronization
5. **Data Security**: Profile data is protected by proper authentication and row-level security policies

### Post-MVP Features (Deferred)
- **Therapy School Preferences**: Advanced therapy school selection and configuration (Story 1.2.1)
- **UI/UX Customization**: Theme and interface personalization options (Story 1.2.2)  
- **Professional Presentation**: Enhanced profile presentation features (Story 1.2.3)
- **Advanced Integration**: Complex integration features for therapy planning (Epic 3)

## Dev Notes

### Previous Story Insights
Story 1.1 established excellent foundations with:
- Robust authentication system using Supabase Auth with 93% test coverage
- Well-structured feature modules in `features/auth/` with TypeScript and Zod validation
- Professional UI components using shadcn/ui and TailwindCSS
- Secure session management and protected routes
- Comprehensive error handling and form validation patterns
[Source: docs/stories/1.1.project-setup-auth.md]

### Data Models
**Therapist Profile Structure:**
- Base user record in `users` table (id, email, role: 'therapist', created_at)
- Extended profile in `therapists` table (id -> users.id, profile, subscription_status)
- Profile JSON structure should include: name, credentials, practice_info, preferences, settings
- All therapist data protected by Row-Level Security (RLS) policies tied to auth.uid()
[Source: docs/architecture/4-backend-database-supabase.md#41-model-danych-propozycja-mvp]

**Therapy Schools Reference:**
- `schools` table (id, name, description) for therapy school options
- Therapist preferences link to school_id for default methodology selection
[Source: docs/architecture/4-backend-database-supabase.md#41-model-danych-propozycja-mvp]

### API Specifications
**Profile Management Endpoints:**
- GET/PUT `/therapists/{id}` - Profile CRUD operations through PostgREST (Supabase)
- GET `/schools` - Available therapy schools list
- Profile updates use Supabase client with automatic RLS enforcement
- All API calls through TanStack Query for caching and synchronization
[Source: docs/architecture/4-backend-database-supabase.md#42-api]

### Component Specifications
**File Locations:**
- Profile components in `frontend/src/features/auth/components/` (extending existing auth module)
- Profile hooks in `frontend/src/features/auth/hooks/` (useProfile, useUpdateProfile)
- Profile services in `frontend/src/features/auth/services/` (profileService.ts)
- Profile types in `frontend/src/features/auth/types.ts` (extending existing auth types)
[Source: docs/architecture/source-tree.md#frontend-project-structure]

**UI Component Requirements:**
- Use shadcn/ui base components (Button, Input, Label, Card, Select, Textarea)
- Follow established patterns from login/register forms in Story 1.1
- Implement responsive design with TailwindCSS utility classes
- Use cn() utility for conditional styling and component variants
[Source: docs/architecture/coding-standards.md#styling-standards-tailwindcss--shadcnui]

### Form Implementation Patterns
**Validation Schema:**
- Zod schemas for profile data validation following established patterns
- TypeScript types inferred from Zod schemas (type ProfileFormData = z.infer<typeof profileSchema>)
- React Hook Form integration with zodResolver for form handling
- Proper error messaging and validation feedback
[Source: docs/architecture/coding-standards.md#form-standards-react-hook-form--zod]

**Example Schema Structure:**
```typescript
const profileSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters'),
  credentials: z.string().optional(),
  practice_info: z.string().optional(),
  therapy_school_id: z.string().uuid('Invalid school selection'),
  ui_preferences: z.object({
    theme: z.enum(['light', 'dark', 'system']),
    language: z.string().default('en')
  })
})
```
[Source: docs/architecture/coding-standards.md#form-standards-react-hook-form--zod]

### State Management
**Profile State Handling:**
- Extend existing auth context or create dedicated profile store using Zustand
- Cache profile data using TanStack Query with proper cache invalidation
- Optimistic updates for better user experience during profile modifications
- Integration with existing auth state for seamless user experience
[Source: docs/architecture/coding-standards.md#state-management-zustand]

### Security Requirements
**Profile Data Protection:**
- All profile modifications require authenticated user session
- Therapist can only modify their own profile (enforced by RLS)
- Sensitive information (credentials, practice details) stored securely
- Password changes integrate with Supabase Auth security protocols
[Source: docs/architecture/4-backend-database-supabase.md#43-rls-row-level-security]

### Testing Requirements
**Test Coverage Standards:**
- Unit tests for profile components using React Testing Library
- Form validation testing with various input scenarios
- Integration tests for profile update workflows
- Mock Supabase client calls for consistent test environment
- Maintain >80% test coverage following Story 1.1 patterns
[Source: docs/architecture/coding-standards.md#testing-standards]

### File Locations
**Implementation Files:**
- `frontend/src/features/auth/components/ProfileForm.tsx` - Main profile editing form
- `frontend/src/features/auth/components/SecuritySettings.tsx` - Password and security management
- `frontend/src/features/auth/hooks/useProfile.ts` - Profile data hook
- `frontend/src/features/auth/hooks/useUpdateProfile.ts` - Profile update mutations
- `frontend/src/features/auth/services/profileService.ts` - Profile API operations
- `frontend/src/features/auth/types.ts` - Extended with profile types
[Source: docs/architecture/source-tree.md#feature-module-structure]

### Integration Points
**Auth System Integration:**
- Extends existing auth context from Story 1.1
- Uses established Supabase client configuration
- Follows existing protected route patterns for profile access
- Integrates with navigation structure in app layout
[Source: docs/stories/1.1.project-setup-auth.md]

**Database Schema Changes:**
- Requires therapists table creation with proper foreign key to users
- RLS policies for secure therapist data access
- Index on therapist_id for efficient profile queries
[Source: docs/architecture/4-backend-database-supabase.md]

### Testing

**Testing Framework Requirements:**
- **Unit Tests**: React Testing Library for component testing
- **Integration Tests**: Test profile API operations with mock Supabase client
- **E2E Tests**: Playwright for complete profile management workflows
- **Coverage Target**: >80% test coverage following Story 1.1 patterns
[Source: docs/architecture/coding-standards.md#testing-standards]

**Test File Locations:**
- Unit tests: `frontend/src/features/auth/components/__tests__/`
- Integration tests: `frontend/src/features/auth/__tests__/`
- Test utilities: `frontend/src/__tests__/helpers/`
- Mock setup: `frontend/src/test-utils.tsx`
[Source: docs/architecture/source-tree.md#frontend-project-structure]

**Specific Test Requirements:**
- Profile form validation with various input scenarios
- Security settings integration with Supabase Auth
- Error handling for network failures and validation errors
- Profile data persistence and synchronization testing
- RLS policy enforcement testing with different user contexts
[Source: docs/architecture/coding-standards.md#component-testing]

## Tasks / Subtasks

### Task 1: Database Foundation (PREREQUISITE - MUST COMPLETE FIRST)
**AC Mapping:** AC3 (Validation), AC5 (Security)
- [ ] Create therapists table migration with basic profile JSON column
- [ ] Set up foreign key relationship to users table (users.id -> therapists.id)
- [ ] Implement RLS policies for therapist profile access using auth.uid()
- [ ] Test database schema with sample therapist profiles
- [ ] Verify RLS policies prevent unauthorized access
- [ ] Create database rollback plan for migration

### Task 2: Profile Data Types & Validation (MVP Core)
**AC Mapping:** AC1 (Profile Creation), AC3 (Validation)
- [ ] Extend auth types with basic TherapistProfile interface
- [ ] Create Zod validation schemas for name, credentials, practice info
- [ ] Define TypeScript types for profile form data
- [ ] Implement profile data transformation utilities
- [ ] Create validation helpers for credentials format
- [ ] Unit tests for type definitions and validation schemas

### Task 3: Profile Management API Integration (MVP Core)
**AC Mapping:** AC1 (Profile Creation), AC4 (Persistence)
- [ ] Create profileService with basic CRUD operations using Supabase client
- [ ] Implement useProfile hook with TanStack Query for data fetching
- [ ] Create useUpdateProfile mutation hook with error handling
- [ ] Implement optimistic updates for better UX
- [ ] Add proper error handling for network and validation errors
- [ ] Integration tests for profile API operations with mocked Supabase

### Task 4: Basic Profile Form Component (MVP Core)
**AC Mapping:** AC1 (Profile Creation), AC3 (Validation)
- [ ] Create ProfileForm component with name, credentials, practice info fields
- [ ] Add form validation using React Hook Form + Zod resolver
- [ ] Implement loading states and user feedback
- [ ] Add proper error display and validation messages
- [ ] Follow shadcn/ui patterns established in Story 1.1
- [ ] Unit tests for ProfileForm component interactions and validation

### Task 5: Security Settings Component (MVP Core)
**AC Mapping:** AC2 (Security Management), AC5 (Data Security)
- [ ] Create SecuritySettings component for password management
- [ ] Integrate with Supabase Auth for password updates
- [ ] Add email change functionality with verification flow
- [ ] Implement proper error handling for auth operations
- [ ] Add security confirmation dialogs for sensitive operations
- [ ] Unit tests for security settings operations

### Task 6: Profile Dashboard Integration (MVP Core)
**AC Mapping:** AC4 (Persistence), Integration with existing auth
- [ ] Create basic ProfileDashboard component as main profile view
- [ ] Integrate profile forms into existing protected route structure
- [ ] Add navigation between profile and security sections
- [ ] Implement profile loading states and error boundaries
- [ ] Ensure proper auth context integration
- [ ] Integration tests for complete profile management workflow

### Task 7: Comprehensive Testing & Quality Assurance
**AC Mapping:** All ACs - Quality assurance
- [ ] End-to-end tests for profile management user journey
- [ ] Performance testing for profile data loading
- [ ] Accessibility testing for profile forms
- [ ] Cross-browser compatibility testing
- [ ] Security testing for RLS policies and auth integration
- [ ] Update documentation for profile management features

## Acceptance Testing Scenarios

### Scenario 1: Basic Profile Creation (MVP Core)
- Therapist logs in and navigates to profile settings
- Fills out basic professional information (name, credentials, practice details)
- Validates form handles required fields and proper formatting
- Saves profile and sees confirmation message
- Logs out and back in to verify profile persistence

### Scenario 2: Security Settings Management (MVP Core)
- Existing therapist navigates to security settings
- Updates password through secure interface with confirmation
- Changes email address with verification flow
- Verifies security changes are properly authenticated
- Confirms all security operations require current password verification

### Scenario 3: Profile Data Validation & Error Handling (MVP Core)
- Therapist attempts to save profile with invalid data
- System displays appropriate validation errors
- Network interruption during save handled gracefully
- Profile data remains consistent after errors
- User receives clear feedback on all operations

## Definition of Done
- [ ] All 5 MVP acceptance criteria implemented and tested
- [ ] Database schema created with therapists table and proper RLS policies  
- [ ] Basic profile forms follow established UI/UX patterns from Story 1.1
- [ ] All components have >80% test coverage with unit, integration, and e2e tests
- [ ] Security requirements validated with password/email management working
- [ ] Profile data properly structured and secured with RLS
- [ ] Integration with existing auth system complete and seamless
- [ ] Database-first implementation sequence followed
- [ ] Code review completed with architecture compliance confirmed
- [ ] All tasks completed in proper dependency order

## Technical Risk Assessment
**Low Risk**: Building on solid foundation from Story 1.1 with established patterns
**Dependencies**: Requires database schema updates and Supabase configuration
**Complexity**: Medium - extends existing patterns without architectural changes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-01 | 1.0 | Initial story creation with comprehensive scope | Product Owner |
| 2025-09-01 | 2.0 | MVP refinement - reduced scope, added missing template sections, resequenced tasks | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent during implementation_

### Debug Log References
_To be populated by development agent during implementation_

### Completion Notes List
_To be populated by development agent during implementation_

### File List
_To be populated by development agent during implementation_

---
*Story Created: 2025-09-01*  
*Epic: 1 - Authentication & Foundation*  
*Priority: High*  
*Estimated Effort: 3-5 days (MVP scope)*

## QA Results

### Review Date: 2025-09-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Pre-Implementation Review with MVP Focus**: Story 1.2 demonstrates excellent architectural planning and thorough requirements analysis. The story builds appropriately on the solid foundation established in Story 1.1, with well-defined database schema, API specifications, and component architecture. However, for MVP delivery, the scope may be overly ambitious and should be streamlined to focus on core therapist profile functionality.

**Strengths Identified:**
- Comprehensive technical specifications with clear file locations
- Proper security design using RLS policies and auth integration  
- Consistent patterns extending from Story 1.1
- Detailed validation schema design with Zod integration
- Well-structured task breakdown with clear acceptance criteria

**MVP Scope Concerns:**
- 8 acceptance criteria may be too broad for initial MVP release
- Complex settings management could be deferred post-MVP
- Professional presentation features add complexity beyond core needs

### Refactoring Performed

No code refactoring performed as implementation has not begun yet.

### Compliance Check

- Coding Standards: ✓ Planned implementation follows established patterns
- Project Structure: ✓ File locations align with feature module structure  
- Testing Strategy: ✓ Comprehensive testing approach with >80% coverage target
- All ACs Met: ✗ No implementation exists yet (story in Draft status)

### Improvements Checklist

**Pre-Implementation Recommendations:**

- [ ] **CRITICAL**: Create database migration for therapists table before frontend development
- [ ] **MVP FOCUS**: Reduce scope to 4-5 core ACs (profile creation, basic settings, security)
- [ ] **SEQUENCE**: Implement database schema first, then basic profile CRUD, then UI
- [ ] **DEFER**: Complex therapy school preferences and professional presentation to v1.1
- [ ] **SIMPLIFY**: Start with JSON profile field, normalize later if needed
- [ ] **TESTING**: Plan unit tests for profile validation, integration tests for API calls

### Security Review

**Status: EXCELLENT** - Security design properly leverages Supabase Auth with RLS policies. Profile data will be properly isolated per therapist using auth.uid() enforcement. Password management integrates with proven Supabase security protocols.

### Performance Considerations

**Status: GOOD** - Planned use of TanStack Query for caching and optimistic updates. Consider implementing profile data prefetching during auth flow for better UX.

### Files Modified During Review

No files modified - story not yet implemented.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.2-therapist-profile-settings.yml

**Key Concerns:**
1. Story not implemented yet (Draft status)
2. Database schema missing - therapists table needs creation first
3. MVP scope could be reduced for faster delivery

### Recommended Status

**✗ Changes Required** - Recommend implementing database schema first, then reducing MVP scope to 4-5 core acceptance criteria focused on basic profile management. Full scope can be addressed in subsequent iterations.

**Next Steps:**
1. Create therapists table migration with RLS policies
2. Simplify story scope for MVP (defer complex settings)
3. Begin with basic profile CRUD operations
4. Implement UI components following established patterns

(Story owner decides final status) 