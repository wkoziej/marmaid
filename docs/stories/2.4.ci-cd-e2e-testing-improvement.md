# Story 2.4: CI/CD E2E Testing Improvement

## Status
Draft

## Story
As a **development team**, I want **E2E tests to run reliably in CI/CD pipeline** so that **we can catch integration issues before deployment and maintain high quality releases**.

## Context
Currently, E2E tests are disabled in the CI/CD pipeline due to webServer timeout issues. This creates a gap in our testing strategy where integration issues might only be discovered in production or manually.

**Dependencies**: Requires completion of Story 2.2 (e2e-test-selector-standardization) and Story 2.3 (client-management-e2e-tests) for stable, comprehensive E2E test suite.

## Problem
- E2E tests are commented out in `.github/workflows/multi-env-deploy.yml` (lines 117-124)
- Missing Playwright browser installation step
- Local environment runs all browsers but CI should be optimized for speed
- No E2E validation before deployment to test/production environments

## Solution Requirements

### Must Have
1. **Enable E2E Tests in CI**: Uncomment and fix E2E test execution
2. **Playwright Installation**: Add proper `npx playwright install chromium --with-deps` step
3. **Timeout Configuration**: Fix webServer timeout issues
4. **Browser Optimization**: Ensure CI only runs Chromium for speed
5. **Environment Variables**: Proper test environment configuration

### Should Have
1. **Parallel Execution**: Optimize test execution time
2. **Retry Logic**: Handle flaky tests with retries
3. **Test Reports**: Generate and store test reports as artifacts
4. **Deployment Gates**: Block deployment if E2E tests fail

### Could Have
1. **Visual Regression**: Add screenshot comparison
2. **Performance Tests**: Basic performance assertions
3. **Mobile Testing**: Add mobile viewport testing in CI

## Acceptance Criteria

### ✅ CI Pipeline Integration
- [ ] E2E tests run successfully in GitHub Actions
- [ ] Playwright browsers install correctly (`chromium --with-deps`)
- [ ] WebServer starts and tests execute within timeout limits
- [ ] Tests run only on Chromium in CI environment

### ✅ Test Execution
- [ ] All existing E2E tests pass in CI environment
- [ ] Test execution time is under 10 minutes
- [ ] Failed tests provide clear error messages and screenshots
- [ ] Tests run after unit/integration tests but before deployment

### ✅ Environment Configuration
- [ ] Test environment variables are properly configured
- [ ] Base URL points to correct test server
- [ ] Authentication and API endpoints work in CI context

### ✅ Deployment Safety
- [ ] Deployment to test environment blocked if E2E tests fail
- [ ] Deployment to production blocked if E2E tests fail
- [ ] Clear feedback on pipeline status and failures

## Dev Notes

### Technical Details
1. **Current CI Structure**: `quality-gates` job needs E2E test step
2. **Playwright Config**: Already optimized for CI (lines 34-54 in config)
3. **WebServer Issue**: Likely timeout in `npm run dev` startup
4. **Dependencies**: Node 20, npm cache already configured

### Files to Modify
- `.github/workflows/multi-env-deploy.yml` - uncomment and fix E2E section
- `playwright.config.ts` - verify CI configuration
- `package.json` - verify E2E test scripts

### Environment Variables Needed
- `PLAYWRIGHT_BASE_URL` - already configured
- `CI` environment variable - already available
- Potentially Supabase test credentials for authenticated tests

## Testing

### Unit Tests
- No unit tests needed (infrastructure change)

### Integration Tests  
- Test CI pipeline with PR to test branch
- Verify E2E tests run and complete successfully
- Test failure scenarios (ensure deployment blocks)

### E2E Tests
- All existing E2E tests should pass in CI
- Test with different viewport sizes
- Verify test reports generation

## Definition of Done
- [ ] E2E tests enabled and running in CI/CD pipeline
- [ ] All existing E2E tests pass consistently  
- [ ] Test execution time under 10 minutes
- [ ] Proper error handling and reporting
- [ ] Deployment gates active (blocks on E2E failure)
- [ ] Documentation updated with CI/E2E testing approach
- [ ] Team can confidently rely on E2E tests catching integration issues

## Risk Assessment
- **Medium**: Changes to CI pipeline could break deployments
- **Low**: Existing E2E tests are working locally
- **Mitigation**: Test changes on feature branch first, gradual rollout